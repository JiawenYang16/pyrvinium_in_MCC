---
title: "IMR90_GRN_analysis"
author: "Jiawen Yang"
discription: "Performing GRN analysis on IMR90 ER and GFP samples"
date: "2023-01-31"
output: 
  html_document:
    theme: simplex
    #code_folding: hide
    toc: true
    number_sections: true
    toc_float: true
---
<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 32px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 24px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 12px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cleanEnv, include=F, echo=F}
rm(list = ls())
gc()
```

# Load libraries
```{r libraryloading, include=T, echo=T, warning=FALSE,message=FALSE}
library(netZooR)
library(igraph)
library(clusterProfiler)
library(org.Hs.eg.db)
library(dplyr)
library(networkD3)
library(plotly)
library(d3wordcloud)
library(DT)
```

# Creating GRN for IMR90 ER (29 samples) and GFP (27 samples) (PANDA + LIONESS) 

## Generating input data for creating PANDA network
```{r Generating input data for creating PANDA network, eval=FALSE, include=TRUE, echo=TRUE}
IMR90_normalized_exp<-readRDS("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_processed/IMR90_realigned_normalized_data.RDS")
IMR90_ppi<-read.table("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/ppi_imr90.txt", sep = "\t", quote = "")
IMR90_motif<-read.table("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/motif_imr90.txt", sep = "\t", quote = "")

IMR90_ALL<-as.data.frame(IMR90_normalized_exp$E)
IMR90_gene<-IMR90_normalized_exp$genes
IMR90_gene<-IMR90_gene[,c("ensembl_gene_id", "hgnc_symbol")]

IMR90_ALL[,"ensembl_gene_id"]<-rownames(IMR90_ALL)
IMR90_ALL<-left_join(IMR90_ALL, IMR90_gene, by = "ensembl_gene_id")
IMR90_ALL<-IMR90_ALL[!IMR90_ALL$hgnc_symbol == "",]
IMR90_ALL<-IMR90_ALL[!duplicated(IMR90_ALL$hgnc_symbol),]
IMR90_ALL<-IMR90_ALL[!is.na(IMR90_ALL$hgnc_symbol),]
rownames(IMR90_ALL)<-IMR90_ALL$hgnc_symbol
IMR90_ALL<-IMR90_ALL[IMR90_ALL$hgnc_symbol %in% unique(c(IMR90_motif$V1, IMR90_motif$V2)), ]
IMR90_ALL<-IMR90_ALL[, 1:(ncol(IMR90_ALL)-2)]

IMR90_ER<-IMR90_ALL[, grep("ER", colnames(IMR90_ALL))]
write.table(IMR90_ER, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/IMR90/panda/IMR90_ER.txt", sep = "\t", quote = F, row.names = F, col.names = F)

IMR90_GFP<-IMR90_ALL[, grep("GFP", colnames(IMR90_ALL))]
write.table(IMR90_GFP, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/IMR90/panda/IMR90_GFP.txt", sep = "\t", quote = F, row.names = F, col.names = F)
```

## Running PANDA and LIONESS in matlab to create single sample netowrk for samples in ER and GFP group
```{octave Running PANDA and LIONESS in matlab, eval=FALSE, echo = T, include = T}
addpath(genpath('/home/u16/jiawenyang/Matlab/netZooM'))

%set program parameters
exp_file  = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/imr90_er.txt';
motif_file = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/motif_imr90.txt';
ppi_file = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/ppi_imr90.txt';
panda_out = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/panda/imr90_er/IMR90_ER_panda.mat';%optional
save_temp = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/panda/imr90_er/';
TF_out = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/panda/imr90_er/TF_out.txt';
GENE_out = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/panda/imr90_er/GENE_out.txt';
alpha      = 0.1;

%%
fid = fopen(exp_file, 'r');
headings = fgetl(fid);
n = length(regexp(headings, '\t'));
frewind(fid);
Exp = textscan(fid, ['%s', repmat('%f', 1, n)], 'delimiter', '\t');
fclose(fid);
GeneNames = Exp{1};
Exp = cat(2, Exp{2:end});
[NumGenes, NumConditions] = size(Exp);
fprintf('%d genes and %d conditions!\n', NumGenes, NumConditions);
Exp = Exp'; %transpose expression matrix from gene-by-sample to sample-by-gene

%%
disp('Reading in motif data!');
[TF, gene, weight] = textread(motif_file, '%s%s%f');
TFNames = unique(TF);
NumTFs = length(TFNames);
[~,i] = ismember(TF, TFNames);
[~,j] = ismember(gene, GeneNames);
RegNet = zeros(NumTFs, NumGenes);
RegNet(sub2ind([NumTFs, NumGenes], i, j)) = weight;
fprintf('%d TFs and %d edges!\n', NumTFs, length(weight));

%%
disp('Reading in ppi data!');
TFCoop = eye(NumTFs);
if(~isempty(ppi_file))
    [TF1, TF2, weight] = textread(ppi_file, '%s%s%f');
    [~,i] = ismember(TF1, TFNames);
    [~,j] = ismember(TF2, TFNames);
    TFCoop(sub2ind([NumTFs, NumTFs], i, j)) = weight;
    TFCoop(sub2ind([NumTFs, NumTFs], j, i)) = weight;
    fprintf('%d PPIs!\n', length(weight));
end

%%
%% ============================================================================
%% Run PANDA
%% ============================================================================
disp('Computing coexpresison network:');
tic; GeneCoReg = Coexpression(Exp); toc;

disp('Normalizing Networks:');
tic
    RegNet = NormalizeNetwork(RegNet);
    GeneCoReg = NormalizeNetwork(GeneCoReg);
    TFCoop = NormalizeNetwork(TFCoop);
toc
disp('Running Panda algorithm:');
tic; AgNet = PANDA(RegNet, GeneCoReg, TFCoop, alpha); toc;

%%
%save all panda out put

if ~isempty(panda_out)
    disp('Saving PANDA network!');
    tic
        [pathstr, name, ext] = fileparts(panda_out);
        switch ext
            case '.txt'
                save(panda_out, 'AgNet', '-ascii');
            case '.tsv'
                save(panda_out, 'AgNet', '-ascii', '-tabs');
            otherwise
                save(panda_out, 'AgNet', '-v6');

        end
    toc
end

%%
%save all temp files
if ~isempty(save_temp)
    disp('Saving the transposed expression matrix and normalized networks:');
    if ~exist(save_temp, 'dir')
        mkdir(save_temp);
    end
    tic
        save(fullfile(save_temp, 'expression.transposed.mat'), 'Exp', '-v7.3');  % 2G+
        save(fullfile(save_temp, 'motif.normalized.mat'), 'RegNet', '-v6');  % fast
        save(fullfile(save_temp, 'ppi.normalized.mat'), 'TFCoop', '-v6');  % fast
    toc
end

fout=fopen(TF_out,'w');
fprintf(fout,'%s\n',string(TFNames));

fout=fopen(GENE_out,'w');
fprintf(fout,'%s\n',string(GeneNames));
%%
disp('All done!');
disp(datestr(now));


%% ============================================================================
%% Load the PANDA outputs for LIONESS
%% ============================================================================

%set program parameters
exp_file  = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/panda/imr90_er/expression.transposed.mat';
motif_file = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/panda/imr90_er/motif.normalized.mat';
ppi_file = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/panda/imr90_er/ppi.normalized.mat';
panda_file = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/panda/imr90_er/IMR90_ER_panda.mat';
save_dir   = '/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/lioness/imr90_er';  % output dir for LIONESS networks
lib_path   = '/home/u16/jiawenyang/Matlab/netZooM';
alpha      = 0.1;
START      = 1;  % sample-of-interest starting from this index
END        = -1;  % sample-of-interest ending to this index; use -1 to end at the last sample
ascii_out  = 1;  % set to 1 if you prefer text output file instead of MAT-file
disp(datestr(now));

%%
%AgNet = AgNet';

%%
disp('Reading in expression data!');
tic
    X = load(exp_file);
    Exp = X.Exp;
    [NumConditions, NumGenes] = size(Exp);  % transposed expression
    fprintf('%d genes and %d conditions!\n', NumGenes, NumConditions);
toc
%%
disp('Reading in motif data!');
tic
    X = load(motif_file);
    RegNet = X.RegNet;
toc
%%
disp('Reading in ppi data!');
tic
    X = load(ppi_file);
    TFCoop = X.TFCoop;
toc
%%
disp('Reading in PANDA network!');
tic
    X = load(panda_file);
    AgNet = X.AgNet;
toc
    
%% ============================================================================
%% Run LIONESS
%% ============================================================================
addpath(genpath('/home/u16/jiawenyang/Matlab/netZooM'))
      
% Create the output folder if not exists
if ~exist(save_dir, 'dir')
    mkdir(save_dir);
end

%% Sample indexes to iterate
if END == -1
    indexes = START:NumConditions;
else
    indexes = START:END;
end

for i = indexes
    fprintf('Running LIONESS for sample %d:\n', i);
    idx = [1:(i-1), (i+1):NumConditions];  % all samples except i

    disp('Computing coexpresison network:');
    tic; GeneCoReg = Coexpression(Exp(idx,:)); toc;

    disp('Normalizing Networks:');
    tic; GeneCoReg = NormalizeNetwork(GeneCoReg); toc;

    disp('Running PANDA algorithm:');
    LocNet = PANDA(RegNet, GeneCoReg, TFCoop, alpha);
    PredNet = NumConditions * (AgNet - LocNet) + LocNet;

    disp('Saving LIONESS network:');
    if ascii_out == 1
        f = fullfile(save_dir, sprintf('lioness_%d.txt', i));
        tic; save(f, 'PredNet', '-ascii'); toc;
    else
        f = fullfile(save_dir, sprintf('lioness_%d.mat', i));
        tic; save(f, 'PredNet', '-v6'); toc;
    end
    fprintf('Network saved to %s\n', f);

    clear idx GeneCoReg LocNet PredNet f; % clean up for next run
end

disp('All done!');
disp(datestr(now));
```
And then, run the code above for IMR90-GFP samples.

## Organizing the LIONESS outputs in R
```{r eval=FALSE, include=TRUE, echo=TRUE}
TF_order<-read.table("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/panda/imr90_er/TF_out.txt")
Gene_order<-read.table("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/panda/imr90_er/GENE_out.txt")

conditions<-c("er", "gfp")

IMR90_lioness<-list()
for (k in 1:length(conditions)){
  condition<-conditions[k]
  print(condition)
  FILES<-list.files(path = paste0("./imr90_", condition, "/"), pattern = "*.txt", full.names = T)
  mat_sample_er<-scan(FILES[1])
  sample_matrix<-matrix(mat_sample_er, nrow = nrow(TF_order), ncol = nrow(Gene_order))
  rownames(sample_matrix)<-TF_order$V1
  colnames(sample_matrix)<-Gene_order$V1
  tf_gene_lioness_weight<-reshape2::melt(sample_matrix)
  colnames(tf_gene_lioness_weight)<-c("TF", "Gene", paste0(condition,"1"))
  for (i in 2:length(FILES)){
    id<-FILES[i]
    id<-strsplit(id, "_")[[1]][3]
    id<-strsplit(id, "[.]")[[1]][1]
    mat<-scan(FILES[i])
    matrix_i<-matrix(mat, nrow = nrow(TF_order), ncol = nrow(Gene_order))
    rownames(matrix_i)<-TF_order$V1
    colnames(matrix_i)<-Gene_order$V1
    tf_gene_edges<-reshape2::melt(matrix_i)
    df<-data.frame(v1 = tf_gene_edges[,3])
    colnames(df)<-paste0(condition,id)
    tf_gene_lioness_weight<-cbind(tf_gene_lioness_weight, df)
  }
  IMR90_lioness[[condition]]<-tf_gene_lioness_weight
}
saveRDS(IMR90_lioness, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn/IMR90_lioness_R_output_organized.RDS")
```

## Organizing the lioness by time period
```{r 5_time periods organization, eval=FALSE, include = T, echo = T}
DATA_DIR<-c("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn")
coldata<-data.frame(samples = colnames(IMR90_normalized_exp), order = as.character(c(1:27, 1:30, 1:24, 1:29)), group = c(rep("GFP", 27), rep("ST", 30), rep("TLT", 24), rep("ER", 29)))

coldata_new<-coldata
coldata_new[,"time"]<-unlist(lapply(coldata_new$samples, function(X) strsplit(X, "_")[[1]][2]))

t1<-c(0,4)
t2<-c(8,12)
t3<-c(16, 20)
t4<-c(24, 32)
t5<-c(40, 48)

time_list_5t_period<-list(t1 = t1, t2 = t2, t3 = t3, t4 = t4, t5 = t5)

IMR90_lioness_t5_mean<-list()
for (i in 1:length(IMR90_lioness)){
  condition<-names(IMR90_lioness)[i]
  df<-IMR90_lioness[[condition]]
  time_period_mean<-IMR90_lioness$IMR90_lioness_gfp[,1:2]
  for (k in 1:length(time_list_5t_period)){
    time_points<-time_list_5t_period[[k]]
    time_points_samples<-coldata_new[coldata_new$time %in% time_points, "samples"]
    subdf<-df[, colnames(df) %in% time_points_samples]
    average_value<-apply(subdf, 1, mean)
    name<-names(time_list_5t_period)[k]
    subdf<-as.data.frame(average_value)
    colnames(subdf)<-name
    time_period_mean<-cbind(time_period_mean, subdf)
  }
  IMR90_lioness_t5_mean[[condition]]<-time_period_mean
}
saveRDS(IMR90_lioness_t5_mean, file = paste0(DATA_DIR, "/IMR90_lioness_t5_period.RDS"))
```

# Detecting differential communities between ER and GFP for each time period (ALPACA)
```{r ALPACA t5, eval=F, include = T, echo = TRUE}
IMR90_lioness_t5_mean<-readRDS(file = paste0(DATA_DIR, "/IMR90_lioness_t5_period.RDS"))

time_conditions2<-c("t1", "t2", "t3", "t4", "t5")
for (i in 2:length(IMR90_lioness_t5_mean)){
  exp_condition<-names(IMR90_lioness_t5_mean)[i]
  exp_condition<-gsub("IMR90_lioness_", "", exp_condition)
  conditioned_net<-IMR90_lioness_t5_mean[[i]]
  for (k in 1:length(time_conditions2)){
    time_condition<-time_conditions2[k]
    conditioned_net_one_time<-conditioned_net[, c("TF", "Gene", time_condition)]
    colnames(conditioned_net_one_time)<-c("TF", "Gene", "Score")
    conditioned_net_one_time[,"V1"]<-IMR90_lioness_t5_mean$IMR90_lioness_gfp[,time_condition]
    control_net_one_time<-conditioned_net_one_time[, c("TF", "Gene", "V1", "Score")]
    colnames(control_net_one_time)<-c("TF", "Gene", "V1", "V2")
    control_net_one_time[,c("V1", "V2")]<-log(exp(1)^control_net_one_time[,c("V1", "V2")]+1, base = exp(1)) #transform the edge weights so that avoid negative values
    net.table<-as.data.frame(control_net_one_time)
    netZooR::alpaca(net.table, file.stem = paste0(DATA_DIR, "/t5_period_transformed/",exp_condition, "_vs_gfp_",time_condition), verbose = T)
  }
}
```

## Generating sankey plot to visualize the dynamic of gene regulatory network modules
```{r Combining GRN analysis result for sankey plot, include = T, echo = T, fig.width=8, fig.height = 6}
DATA_DIR<-c("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_grn")
# 1.Creating the function that used to create the plots
sanktify <- function(x) {

  # Create nodes DF with the unique sources & targets from input
  nodes <- data.frame(unique(c(x$source,x$target)),stringsAsFactors=FALSE)
  nodes$ID <- as.numeric(rownames(nodes)) - 1 # sankeyNetwork requires IDs to be zero-indexed
  names(nodes) <- c("name", "ID")

  # use dplyr join over merge since much better; in this case not big enough to matter
  # Replace source & target in links DF with IDs
  links <- inner_join(x, nodes, by = c("source"="name"))
  links<- inner_join(links, nodes, by = c("target"="name"))
  colnames(links)<-c("source", "target", "value", "source_ID", "target_ID")

  # Create Sankey Plot
  sank <- sankeyNetwork(
    Links = links,
    Nodes = nodes,
    Source = "source_ID",
    Target = "target_ID",
    Value = "value",
    NodeID = "name",
    fontSize = 10,
    nodeWidth = 40
  )
  return(sank)
}

# 2.Organizing the ALPACA outputs from different time periods for Sankey plot
FILES<-list.files(path = paste0(DATA_DIR, "/t5_period_transformed"), 
                  pattern = "*_ALPACA_final_memb.txt",
                  full.names = T,
                  recursive = T)

alpaca_t5_period<-lapply(FILES, function(x) read.table(x, sep = "", quote = ""))
names(alpaca_t5_period)<-c("t1", "t2", "t3","t4", "t5")

alpaca_t5_period_df<-left_join(alpaca_t5_period$t1, alpaca_t5_period$t2, by = "V1")
alpaca_t5_period_df<-left_join(alpaca_t5_period_df, alpaca_t5_period$t3, by = "V1")
alpaca_t5_period_df<-left_join(alpaca_t5_period_df, alpaca_t5_period$t4, by = "V1")
alpaca_t5_period_df<-left_join(alpaca_t5_period_df, alpaca_t5_period$t5, by = "V1")
colnames(alpaca_t5_period_df)<-c("Gene", "t1", "t2", "t3", "t4", "t5")

n = 30 #remove the modules whose size are less than 30
remove_genes_list<-c()
for (i in 1:5){
  time_period<-paste0("t", i)
  df<- as.data.frame(table(alpaca_t5_period_df[,time_period]))
  module_number<-df[,1][df[,2] <= n]
  remove_genes<-alpaca_t5_period_df[alpaca_t5_period_df[,time_period] %in% module_number, "Gene"]
  remove_genes_list<-c(remove_genes_list, remove_genes)
}

alpaca_t5_period_df_new<-alpaca_t5_period_df[!alpaca_t5_period_df[, "Gene"] %in% remove_genes_list,]


alpaca_t5_period_t1<-as.data.frame(table(alpaca_t5_period_df_new$t1))
alpaca_t5_period_t2<-as.data.frame(table(alpaca_t5_period_df_new$t2))
alpaca_t5_period_t3<-as.data.frame(table(alpaca_t5_period_df_new$t3))
alpaca_t5_period_t4<-as.data.frame(table(alpaca_t5_period_df_new$t4))
alpaca_t5_period_t5<-as.data.frame(table(alpaca_t5_period_df_new$t5))

t1_to_t2<-data.frame()
for (i in 1:length(unique(alpaca_t5_period_t1$Var1))){
   from_node<-unique(alpaca_t5_period_t1$Var1)[i]
   z<-data.frame()
   for(k in 1:length(unique(alpaca_t5_period_t2$Var1))){
     to_node<-unique(alpaca_t5_period_t2$Var1)[k]
     value = nrow(alpaca_t5_period_df_new[alpaca_t5_period_df_new$t1 == from_node & alpaca_t5_period_df_new$t2 == to_node,])
     df<-data.frame(source = paste0("t1_module_", from_node), target = paste0("t2_module_",to_node), value = value)
     z = rbind(z, df)
   }
  t1_to_t2<-rbind(t1_to_t2, z)
}

t2_to_t3<-data.frame()
for (i in 1:length(unique(alpaca_t5_period_t2$Var1))){
   from_node<-unique(alpaca_t5_period_t2$Var1)[i]
   z<-data.frame()
   for(k in 1:length(unique(alpaca_t5_period_t3$Var1))){
     to_node<-unique(alpaca_t5_period_t3$Var1)[k]
     value = nrow(alpaca_t5_period_df_new[alpaca_t5_period_df_new$t2 == from_node & alpaca_t5_period_df_new$t3 == to_node,])
     df<-data.frame(source = paste0("t2_module_", from_node), target = paste0("t3_module_",to_node), value = value)
     z = rbind(z, df)
   }
  t2_to_t3<-rbind(t2_to_t3, z)
}

t3_to_t4<-data.frame()
for (i in 1:length(unique(alpaca_t5_period_t3$Var1))){
   from_node<-unique(alpaca_t5_period_t3$Var1)[i]
   z<-data.frame()
   for(k in 1:length(unique(alpaca_t5_period_t4$Var1))){
     to_node<-unique(alpaca_t5_period_t4$Var1)[k]
     value = nrow(alpaca_t5_period_df_new[alpaca_t5_period_df_new$t3 == from_node & alpaca_t5_period_df_new$t4 == to_node,])
     df<-data.frame(source = paste0("t3_module_", from_node), target = paste0("t4_module_",to_node), value = value)
     z = rbind(z, df)
   }
  t3_to_t4<-rbind(t3_to_t4, z)
}

t4_to_t5<-data.frame()
for (i in 1:length(unique(alpaca_t5_period_t4$Var1))){
   from_node<-unique(alpaca_t5_period_t4$Var1)[i]
   z<-data.frame()
   for(k in 1:length(unique(alpaca_t5_period_t5$Var1))){
     to_node<-unique(alpaca_t5_period_t5$Var1)[k]
     value = nrow(alpaca_t5_period_df_new[alpaca_t5_period_df_new$t4 == from_node & alpaca_t5_period_df_new$t5 == to_node,])
     df<-data.frame(source = paste0("t4_module_", from_node), target = paste0("t5_module_",to_node), value = value)
     z = rbind(z, df)
   }
  t4_to_t5<-rbind(t4_to_t5, z)
}

t_all<-Reduce(bind_rows, list(t1_to_t2, t2_to_t3, t3_to_t4, t4_to_t5))
sanktify(t_all)
```

## Applying threshold to gene modules and performing go enrichment analysis on gene modules from different time periods
```{r GO enrichment for t5 transformed ALPACA result, eval = FALSE, include=T, echo=T}
time_points<-c("t1", "t2", "t3", "t4", "t5")
ER_modules_enrichment_result_t5<-list()
for (i in 1:5){
  time_point<-time_points[i]
  alpaca_community<-read.table(FILES[i], sep = "", quote = "")
  alpaca_community<-alpaca_t5_period_df_new[,c("Gene", time_point)]
  alpaca_community[,"gene"]<-unlist(lapply(alpaca_community[,"Gene"], function(x) strsplit(x, "_")[[1]][1]))
  alpaca_community[,"type"]<-unlist(lapply(alpaca_community[,"Gene"], function(x) strsplit(x, "_")[[1]][2]))
  alpaca_community<-alpaca_community[,c("gene", "type", time_point)]
  colnames(alpaca_community)<-c("gene", "type", "community")
  ER_modules_enrichment_result<-list()
    for (k in 1:length(unique(alpaca_community$community))){
      module<-unique(alpaca_community$community)[k]
      gene_list<-alpaca_community[alpaca_community$community == module, "gene"]
      label<-paste0("er_vs_gfp_",time_point, "_module_", module)
      print(label)
      if (length(gene_list) < 10){
        print(gene_list) 
        print("There are too few genes in the list to perform enrichment analysis")
      }
      else {
        ER_BP<-enrichGO(gene_list, 
                         OrgDb = org.Hs.eg.db, 
                         ont = "BP",
                         pAdjustMethod = "BH", 
                         pvalueCutoff = 0.05,
                         qvalueCutoff = 0.25, 
                         keyType = 'SYMBOL')
        #datatable(ER_BP@result)
        ER_modules_enrichment_result[[label]]<-ER_BP@result
      }
     }
 ER_modules_enrichment_result_t5<-c(ER_modules_enrichment_result_t5, ER_modules_enrichment_result)
}
saveRDS(ER_modules_enrichment_result_t5, file = paste0(DATA_DIR, "/IMR90_ER_GFP_lioness_alpaca_transformed_t5_GO_enrichment_applying_threshold.RDS"))
```

## Selecting top terms from the GO TERM analysis result in each gene module
```{r t5_gene_lists, include = T, echo = T}
ER_modules_enrichment_result_t5<-readRDS(paste0(DATA_DIR, "/IMR90_ER_GFP_lioness_alpaca_transformed_t5_GO_enrichment_applying_threshold.RDS"))

ER_modules_enrichment_result_t5_sig<-list()
for (i in 1:length(ER_modules_enrichment_result_t5)){
  condition<-names(ER_modules_enrichment_result_t5)[i]
  go_result<-ER_modules_enrichment_result_t5[[condition]]
  go_result<-go_result[go_result$p.adjust <= 0.05, ]
  go_result<-go_result[order(go_result$p.adjust, decreasing = F), ][1:100,]
  go_result<-go_result[order(go_result$Count, decreasing = T), ][1:30,]
  go_result<-go_result[go_result$Description != "<NA>",]
  go_result<-na.omit(go_result)
  if (is.na(go_result[1,"ID"]) == "FALSE") {
  ER_modules_enrichment_result_t5_sig[[condition]]<-go_result}
}
#t5 module 1
DT::datatable(ER_modules_enrichment_result_t5_sig$er_vs_gfp_t5_module_1)

#t5 module 2
DT::datatable(ER_modules_enrichment_result_t5_sig$er_vs_gfp_t5_module_2)
```

See attached supplemental table for enriched go terms in all modules from different time periods : ER_modules_enrichment_result_t5_sig.xlsx

```{r d3wordcloud to show the GO term analysis result, include=F, echo=F}
#Visualize the GO_term with d3wordcloud
# generate d3wordcloud object for individual module of genes for significant GO terms
#color_list<-c("#4E82B7", "#BBCCE8", "#F09249", "#77342F", "#76506E", "#797A5C", 
#              "#68C2D1", "#4E82B8", "#F0924A", "#F5C38D", "#62A850", "#C8B8D6",
#              "#EFC0D7", "#CCCDCD", "#C2C357", "#DDDD9F", "#68C2D2", "#4E82B7", "#9878BF",
#              "#D98AC4", "#BCCCE8")
#d3wordcloud(ER_modules_enrichment_result_t5_sig$er_vs_gfp_t5_module_1$Description, (-log(ER_modules_enrichment_result_t5_sig$er_vs_gfp_t5_module_1$p.adjust, 2))^(1/2), colors = color_list[1], rotate.min = 0, rotate.max = 0, spiral = "rectangular")
```




