---
title: "IMR90_WGCNA_analysis"
author: "Jiawen Yang"
date: "2022-12-09"
discritpion: "Performing WGCNA analysis on IMR90 ER samples"
output: 
  html_document:
    theme: simplex
    #code_folding: hide
    toc: true
    number_sections: true
    toc_float: true
---
<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 32px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 24px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 12px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r clean environment, include=FALSE, echo = F}
rm(list = ls())
gc()
```

# Load libraries
```{r, load libraries, including=F, echo=T, warning=FALSE,message=FALSE}
library(limma)
library(edgeR)
library(ggplot2)
library(RColorBrewer)
library(stringr)
library(ggrepel)
library(plotly)
library(processx)
library(biomaRt)
library(WGCNA)
library(clusterProfiler)
library(org.Hs.eg.db)
library(ggpubr)
library(dplyr)
library(igraph)
library(DT)
library(networkD3)
```

# Importing data to the environment
```{r Import data to the environment, including=T, echo=T}
#IMR90 normalized expression matrix =========
df<-readRDS("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_wgcna/IMR90_edat.RDS")
IMR90_ER_edat<-df[,grep("ER", colnames(df))]
IMR90_GFP_edat<-df[,grep("GFP", colnames(df))]
IMR90_ER_GFP_edat<-cbind(IMR90_GFP_edat, IMR90_ER_edat)
```

# IMR90 data processing 
```{r IMR90 data processing, including=T, echo = T}
#ER_samples =======================
df_er<-df[, grep("ER", colnames(df))]

df_er.pca = prcomp(t(df_er), center = TRUE, scale = TRUE)
group_er<-factor(c(rep("ER_0", 3), rep("ER_4", 3), rep("ER_8", 3), 
                   rep("ER_12", 3), rep("ER_16", 3), rep("ER_20", 3), 
                   rep("ER_24", 3), rep("ER_32", 3), rep("ER_40", 2), rep("ER_48",3)),
                   levels = c("ER_0", "ER_4", "ER_8", "ER_12", "ER_16", "ER_20",
                              "ER_24", "ER_32", "ER_40", "ER_48"))

df_er.plot=data.frame(df_er.pca$x[,1],df_er.pca$x[,2],group_er, rownames(df_er.pca$x))
colnames(df_er.plot)=c("PC1","PC2","group_er","cond")
rownames(df_er.plot)=rownames(df_er.pca$x)
percentage_er <- round(df_er.pca$sdev / sum(df_er.pca$sdev) * 100, 2)
percentage_er_lab <- paste(colnames(df_er.plot), "(", paste( as.character(percentage_er), "%", ")", sep=""))

#GFP_samples =========================
df_gfp<-df[, grep("GFP", colnames(df))]

df_gfp.pca = prcomp(t(df_gfp), center = TRUE, scale = TRUE)
group_gfp<-factor(c(rep("GFP_0", 3), rep("GFP_4", 2), rep("GFP_8", 3), 
                   rep("GFP_12", 1), rep("GFP_16", 3), rep("GFP_20", 3), 
                   rep("GFP_24", 3), rep("GFP_32", 3), rep("GFP_40", 3), rep("GFP_48",3)),
                   levels = c("GFP_0", "GFP_4", "GFP_8", "GFP_12", "GFP_16", "GFP_20",
                              "GFP_24", "GFP_32", "GFP_40", "GFP_48"))

df_gfp.plot=data.frame(df_gfp.pca$x[,1],df_gfp.pca$x[,2],group_gfp, rownames(df_gfp.pca$x))
colnames(df_gfp.plot)=c("PC1","PC2","group_gfp","cond")
rownames(df_gfp.plot)=rownames(df_gfp.pca$x)
percentage_gfp <- round(df_gfp.pca$sdev / sum(df_gfp.pca$sdev) * 100, 2)
percentage_gfp_lab <- paste(colnames(df_gfp.plot), "(", paste( as.character(percentage_gfp), "%", ")", sep=""))
```

# Plotting 3D PCA plot of IMR90 ER and GFP samples
```{r 3D PCA plot of IMR90 ER samples, includ=T, echo=T}
tot_explained_variance_ratio_er <- summary(df_er.pca)[["importance"]]['Proportion of Variance',]
tot_explained_variance_ratio_er<- 100 * sum(tot_explained_variance_ratio_er)

tit_er<-paste0("Total Explained Variance = ", tot_explained_variance_ratio_er, "\n PCA of normalized IMR90 ER samples")

components_er<-data.frame(df_er.pca$x[,1],df_er.pca$x[,2],df_er.pca$x[,3], group_er, rownames(df_er.pca$x))
colnames(components_er)<-c("PC1","PC2", "PC3", "group_er", "sample_names")

axx <- list(
  title = paste0("PC1 (", percentage_er[1], ")" ))
axy <- list(
  title = paste0("PC2 (", percentage_er[2], ")" ))

axz <- list(
  title = paste0("PC3 (", percentage_er[3], ")" ))

fig_er <- plot_ly(components_er, x = ~PC1, y = ~PC2, z = ~PC3, color = ~group_er, colors = c('#636EFA','#EF553B','#00CC96')) %>%
  add_markers(size = 28)


fig_er <- fig_er %>%
  layout(
    title = tit_er,
    scene = list(bgcolor = "white", 
                 xaxis=axx, 
                 yaxis=axy, 
                 zaxis=axz)
    )

fig_er
```

```{r 3D PCA plot of IMR90 GFP samples, include=TRUE}
tot_explained_variance_ratio_gfp <- summary(df_gfp.pca)[["importance"]]['Proportion of Variance',]
tot_explained_variance_ratio_gfp<- 100 * sum(tot_explained_variance_ratio_gfp)

tit_gfp<-paste0("Total Explained Variance = ", tot_explained_variance_ratio_gfp, "\n PCA of normalized IMR90 GFP samples")

components_gfp<-data.frame(df_gfp.pca$x[,1],df_gfp.pca$x[,2],df_gfp.pca$x[,3], group_gfp, rownames(df_gfp.pca$x))
colnames(components_gfp)<-c("PC1","PC2", "PC3", "group_gfp", "sample_names")

axx <- list(
  title = paste0("PC1 (", percentage_gfp[1], ")" ))

axy <- list(
  title = paste0("PC2 (", percentage_gfp[2], ")" ))

axz <- list(
  title = paste0("PC3 (", percentage_gfp[3], ")" ))


fig_gfp <- plot_ly(components_gfp, x = ~PC1, y = ~PC2, z = ~PC3, color = ~group_gfp, colors = c('#636EFA','#EF553B','#00CC96')) %>%
  add_markers(size = 28)


fig_gfp <- fig_gfp %>%
  layout(
    title = tit_gfp,
    scene = list(bgcolor = "white",
                 xaxis=axx, 
                 yaxis=axy, 
                 zaxis=axz))

fig_gfp
```

# Diffierentially expressed genes analysis of IMR90 ER and GFP samples at 48h 
```{r DEGs_48h_ER_GFP, include=TRUE}
group_48h_DEGs<-factor(c(rep("GFP_48",3), rep("ER_48",3)), levels = c("GFP_48", "ER_48"))
design<-model.matrix(~0 + group_48h_DEGs)
IMR90_48h_ER_GFP<-df[,c(grep("GFP_48",colnames(df)), grep("ER_48", colnames(df)))]
comparison = "group_48h_DEGsER_48 - group_48h_DEGsGFP_48"
cont=makeContrasts(comparison,levels=design)
fit=lmFit(IMR90_48h_ER_GFP,design)
vfit=contrasts.fit(fit,contrasts=cont)
efit<- eBayes(vfit)
DEGs_48h<-topTreat(efit, sort.by = "P", n = Inf)
dim(DEGs_48h)

DEGs_48h_sig_gene_list<-DEGs_48h[abs(DEGs_48h$logFC)>=0 & DEGs_48h$adj.P.Val <= 0.05,]
dim(DEGs_48h_sig_gene_list)

IMR90_ER_sig_DEGs<-df[rownames(DEGs_48h_sig_gene_list), grep("ER", colnames(df))]
dim(IMR90_ER_sig_DEGs)
```

# Gene co-expression analysis by WGCNA with IMR90 ER samples
```{r WGCNA, eval=F, include=TRUE, echo=TRUE}
#Clustering by WGCNA (IMR90 48h ER vs.GFP DEGs with abs lfc > = 0 & padj <= 0.05,  total 10513 genes) 

nettype = "signed"
powers = c(c(1:10), seq(from = 12, to=20, by=2))
IMR90_ER_expression_data<-IMR90_ER_sig_DEGs

sft_ER=pickSoftThreshold(t(IMR90_ER_expression_data), dataIsExpr = TRUE, powerVector = powers, networkType = nettype, verbose = 5)

# Scale-free topology fit index as a function of the soft-thresholding power
plot(sft_ER$fitIndices[,1], -sign(sft_ER$fitIndices[,3])*sft_ER$fitIndices[,2],
     xlab="Soft Threshold (power)",ylab= paste0("Scale Free Topology Model Fit ", nettype, " R^2"), type="n",
     main = paste("Scale independence"))+text(sft_ER$fitIndices[,1], -sign(sft_ER$fitIndices[,3])*sft_ER$fitIndices[,2],
     labels=powers,cex=1,col="red")+abline(h=0.90,col="red")

# Mean connectivity as a function of the soft-thresholding power
plot(sft_ER$fitIndices[,1], sft_ER$fitIndices[,5],
     xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",
     main = paste("Mean connectivity"))+text(sft_ER$fitIndices[,1], sft_ER$fitIndices[,5], labels=powers, cex=1, col="red")


##Create co-expression matrix=========================
cor <- WGCNA::cor
net_ER = blockwiseModules(
  t(IMR90_ER_expression_data),
  power = 16 , #https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/faq.html Q#6 or based on powerEstimate
  TOMType = "signed", 
  minModuleSize = 30,   # We like large modules, so we set the minimum module size relatively high
  reassignThreshold = 0, 
  mergeCutHeight = 0.25,
  numericLabels = TRUE, 
  pamRespectsDendro = FALSE,
  saveTOMs = F,
  verbose = 3
)
table(net_ER$colors)
cor<-stats::cor
#saveRDS(net_ER, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_wgcna/WGCNA_net_ER.rds")
```

## Gene modules analysis on IMR90 ER samples
```{r visuzlize the network-1, include=TRUE, echo=TRUE, fig.width=5, fig.height=3}
IMR90_ER_expression_data<-IMR90_ER_sig_DEGs
net_ER<-readRDS(file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_wgcna/WGCNA_net_ER.rds")
sizeGrWindow(12,10)
moduleLabels = net_ER$colors
mergedColors = labels2colors(net_ER$colors)
plotDendroAndColors(net_ER$dendrograms[[1]], mergedColors[net_ER$blockGenes[[1]]],
                    "Module colors",
                    dendroLabels = FALSE, hang = 0.03,
                    addGuide = TRUE, guideHang = 0.05)
reference_df<-data.frame(gene = names(moduleLabels), number = unname(moduleLabels), color = mergedColors)

MEs = net_ER$MEs;
geneTree = net_ER$dendrograms[[1]];

# Module identification using dynamic tree cut:
minModuleSize = 30
dynamicMods = cutreeDynamic(dendro = geneTree,
                            deepSplit = 2, 
                            pamRespectsDendro = FALSE,
                            minClusterSize = minModuleSize);
table(dynamicMods)

# Convert numeric lables into colors
dynamicColors = labels2colors(dynamicMods)
table(dynamicColors)

# Plot the dendrogram and colors underneath
#sizeGrWindow(10,8)
plotDendroAndColors(geneTree, dynamicColors, "Dynamic Tree Cut",
                    dendroLabels = FALSE, hang = 0.03,
                    addGuide = TRUE, guideHang = 0.05,
                    main = "Gene dendrogram and module colors")

# Module-trait(timepoint) relationship for ER samples
head(IMR90_ER_expression_data)
design_ER<-colnames(IMR90_ER_expression_data)
design_ER<-unlist(lapply(design_ER, function(x) substring(x, 1, nchar(x)-2)))
design_ER<-gsub("_48", "_t5",design_ER)
design_ER<-gsub("_40", "_t5",design_ER)
design_ER<-gsub("_32", "_t4",design_ER)
design_ER<-gsub("_24", "_t4",design_ER)
design_ER<-gsub("_20", "_t3",design_ER)
design_ER<-gsub("_16", "_t3",design_ER)
design_ER<-gsub("_12", "_t2",design_ER)
design_ER<-gsub("_8", "_t2",design_ER)
design_ER<-gsub("_4", "_t1",design_ER)
design_ER<-gsub("_0", "_t1",design_ER)
design_er = model.matrix(~0 + design_ER)
colnames(design_er) = levels(as.factor(design_ER))

moduleTraitCor = cor(MEs, design_er, use = "p")
nSamples = ncol(t(IMR90_ER_expression_data))
#moduleTraitPvalue_student = corPvalueStudent(moduleTraitCor, nSamples) #Student asymptotic p-value for correlation
moduleTraitPvalue_fisher = corPvalueFisher(moduleTraitCor, nSamples) #Fisher's asymptotic p-value for correlation

sizeGrWindow(10,6)
# Display correlations and their p-values
textMatrix = paste(signif(moduleTraitCor, 2), "\n(",
                   signif(moduleTraitPvalue_fisher, 1), ")", sep = "");
dim(textMatrix) = dim(moduleTraitCor)
par(mar = c(5, 5, 5, 5));

# Display the correlation values within a heatmap
colnames(MEs)<-substr(colnames(MEs), 3, nchar(colnames(MEs)))
colnames(MEs)<-paste0("Module ", colnames(MEs))
#moduleTraitCor<-moduleTraitCor[,factor(c("ER_0", "ER_early", "ER_middle", "ER_late"), levels = c("ER_0", "ER_early", "ER_middle", "ER_late"))]
moduleTraitCor<-moduleTraitCor[,factor(c("ER_t1", "ER_t2", "ER_t3", "ER_t4", "ER_t5"), levels = c("ER_t1", "ER_t2", "ER_t3", "ER_t4", "ER_t5"))]
rownames(moduleTraitCor)<-paste0("Module_", unlist(lapply(rownames(moduleTraitCor), function(x) substr(x, 3, nchar(x)))))

#pdf(file = "/xdisk/mpadi/jiawenyang/result/merkel_cell/pp_in_mcc_paper/figure/IMR90_WGCNA_Module-time_period_relationships.pdf")
labeledHeatmap(Matrix = moduleTraitCor,
               #xLabels = c("ER_0", "ER_early", "ER_middle", "ER_late"),
               xLabels = c("ER_t1", "ER_t2", "ER_t3", "ER_t4", "ER_t5"),
               yLabels = names(MEs),
               ySymbols = names(MEs),
               colorLabels = FALSE,
               colors = blueWhiteRed(100),
               textMatrix = textMatrix,
               setStdMargins = T,
               cex.text = 0.4,
               zlim = c(-1,1),
               main = paste("IMR90_ER: Module-time period relationships"))
#dev.off()
# plot Eigengene adjacency heatmap
#pdf(file = "/xdisk/mpadi/jiawenyang/result/merkel_cell/pp_in_mcc_paper/figure/IMR90_WGCNA_Eigengene_adjacency_heatmap.pdf")
plotEigengeneNetworks(MEs, "", marDendro = c(0,4,1,2), marHeatmap = c(3,4,1,2), cex.lab = 0.8, xLabelsAngle = 30)
#dev.off()
```
## Eigengene analysis on IMR90 ER samples
```{r visuzlize the network-2, include=TRUE, echo=TRUE, fig.width=12, fig.height=8}
# 1. Performing Eigengene analysis on gene modules across time in IMR90 ER samples
ER_time_point<-c("ER_0", "ER_4", "ER_8", 
                 "ER_12", "ER_16", "ER_20", 
                 "ER_24", "ER_32", "ER_40", 
                 "ER_48")

MEs_mean<-data.frame(modules = rownames(t(MEs)))
for (i in 1:length(ER_time_point)){
  time_point<-ER_time_point[i]
  sub_df<-as.data.frame(t(MEs)[, grep(time_point, colnames(t(MEs)))])
  sub_df[,"mean"]<-apply(sub_df, 1, mean)
  df_mean<-as.data.frame(sub_df[, "mean"])
  colnames(df_mean)<-time_point
  MEs_mean<-cbind(MEs_mean, df_mean)
}

rownames(MEs_mean)<-MEs_mean$modules
MEs_mean<-MEs_mean[,-1]
MEs_mean_df<-reshape2::melt(as.matrix(MEs_mean))

colnames(MEs_mean_df)<-c("Module", "time", "Eigengene")
MEs_mean_df$time<-unlist(lapply(as.character(MEs_mean_df$time), function(x) strsplit(x, "_")[[1]][2]))
MEs_mean_df$time<-as.numeric(MEs_mean_df$time)
MEs_mean_df$Eigengene<-as.numeric(MEs_mean_df$Eigengene)

theme<-theme(panel.background = element_blank(),
             panel.border=element_rect(fill=NA),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             strip.background=element_blank(),
             axis.text.x=element_text(colour="black"),
             axis.text.y=element_text(colour="black"),
             axis.ticks=element_line(colour="black"),
             plot.margin=unit(c(1,1,1,1),"line"),
             axis.title.x = element_text(color="black", size=20, face="bold"),
             axis.title.y = element_text(color="black", size=20, face="bold"),
             axis.text = element_text(size = 20, face = "bold"))

for (i in 1:length(rownames(MEs_mean))){
  module<-rownames(MEs_mean)[i]
  df_module<-MEs_mean_df[MEs_mean_df$Module == module,]
  p<-ggplot(df_module, 
       aes(x=factor(time, levels = c(0,4,8,12,16,20,24,32,40,48)),
           y=Eigengene, colour=Module, group=Module, fill=Module)) +
  geom_line(size =0.1)+
  geom_point(size=0.5)+
  ylim(-0.4, 0.4)+
  labs(x = 'time (h)', y = "Eigengene",title = 'Eigengenes of the each WGCNA modules')
  #plot(p)
}

# 2. Putting the dynamic Eigengene curve of each module into groups based on the distance of modules

  p1<-ggplot(MEs_mean_df[MEs_mean_df$Module %in% c("Module 14", "Module 1", "Module 11"), ],
      mapping = aes(x=factor(time, levels = c(0,4,8,12,16,20,24,32,40,48)), y=Eigengene, group = Module, fill = Module)) +
  geom_line(aes(color=Module), size = 0.8)+
  geom_point(size=2, shape = 21)+
  scale_fill_brewer(palette = "Blues")+
  scale_color_brewer(palette = "Blues")+
  ylim(-0.4, 0.4)+
  labs(x = 'time (h)', y = "Eigengene")

  p1<-p1+theme

  p2<-ggplot(MEs_mean_df[MEs_mean_df$Module %in% c("Module 13", "Module 5", "Module 10", "Module 12"), ],
      mapping = aes(x=factor(time, levels = c(0,4,8,12,16,20,24,32,40,48)), y=Eigengene, group = Module, fill = Module)) +
  geom_line(aes(color=Module), size = 0.8)+
  geom_point(size=2, shape = 21)+
  scale_fill_brewer(palette = "Greens")+
  scale_color_brewer(palette = "Greens")+
  ylim(-0.4, 0.4)+
  labs(x = 'time (h)', y = "Eigengene")

  p2<-p2+theme
  
  p3<-ggplot(MEs_mean_df[MEs_mean_df$Module %in% c("Module 4", "Module 3", "Module 8"), ],
      mapping = aes(x=factor(time, levels = c(0,4,8,12,16,20,24,32,40,48)), y=Eigengene, group = Module, fill = Module)) +
  geom_line(aes(color=Module), size = 0.8)+
  geom_point(size=2, shape = 21)+
  scale_fill_brewer(palette = "Oranges")+
  scale_color_brewer(palette = "Oranges")+
  ylim(-0.4, 0.4)+
  labs(x = 'time (h)', y = "Eigengene")

  p3<-p3+theme
  
  p4<-ggplot(MEs_mean_df[MEs_mean_df$Module %in% c("Module 6", "Module 9", "Module 7", "Module 2"), ],
      mapping = aes(x=factor(time, levels = c(0,4,8,12,16,20,24,32,40,48)), y=Eigengene, group = Module, fill = Module)) +
  geom_line(aes(color=Module), size = 0.8)+
  geom_point(size=2, shape = 21)+
  scale_fill_brewer(palette = "Purples")+
  scale_color_brewer(palette = "Purples")+
  ylim(-0.4, 0.4)+
  labs(x = 'time (h)', y = "Eigengene")

  p4<-p4+theme

  WGCNA_Eigengenes_plot<-ggarrange(p1, p2, p3, p4, 
              ncol = 2,
              nrow = 2
) 
 WGCNA_Eigengenes_plot
 
#pdf(file = "/xdisk/mpadi/jiawenyang/result/merkel_cell/pp_in_mcc_paper/figure/IMR90_WGCNA_Eigengenes_dynamics.pdf", width = 12, height = 8)
#WGCNA_Eigengenes_plot
#dev.off()
```

## GO-terms analysis on gene modules from IMR90 ER samples
```{r organizing_genes_in_each_WGCNA_module_for_G0_TERMS_analysis, include=TRUE, echo=TRUE}
#genemart <- useDataset("hsapiens_gene_ensembl", useMart("ensembl"))
#saveRDS(genemart, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/genemart.rds")
genemart<-readRDS("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_wgcna/genemart.rds")
probes = colnames(t(IMR90_ER_expression_data))
g_list<-getBM(filters = "hgnc_symbol", 
                       attributes= c("ensembl_gene_id","hgnc_symbol", "entrezgene_id"),values=probes,mart= genemart)
gene_list<-list()
for (i in 1:length(unique(moduleLabels))){
  number<-unique(moduleLabels)[i]
  module_name<-paste0("Module_", number)
  modnumber<-probes[moduleLabels == number]
  df_genes<-g_list[g_list$hgnc_symbol %in% modnumber,"ensembl_gene_id"]
  gene_list[[module_name]]<-df_genes
}
#names(gene_list)<-paste0("Module_", unique(moduleLabels))

gene_df<-list()
module_name_list<-paste0("Module_", c(1:14))
for (i in 1:14){
  module_name<-module_name_list[i] #remove Module_0, since it's the module with genes that do not co-express with others
  genes<-gene_list[[module_name]]
  df_genes<-g_list[g_list$ensembl_gene_id %in% genes,]
  df_genes<-df_genes[!duplicated(df_genes$hgnc_symbol),]
  gene_df[[module_name]]<-df_genes
}
```

```{r GO_term enrichment analysis, eval=FALSE, include=TRUE, echo=TRUE}
##GO-Term enrichment based on WGCNA network================================
WGCNA_modules_go_result<-list()
for (i in 1:length(gene_df)){
  module_name<-names(gene_df)[i]
  genes<-gene_df[[module_name]]
  genes<-genes$hgnc_symbol
  em_ER_BP<-enrichGO(genes, 
                     OrgDb = org.Hs.eg.db, 
                     ont = "BP",
                   pAdjustMethod = "BH", 
                     pvalueCutoff = 0.05,
                     qvalueCutoff = 0.25, 
                     keyType = 'SYMBOL')
 WGCNA_modules_go_result[[module_name]]<-em_ER_BP@result
}
#saveRDS(WGCNA_modules_go_result, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/IMR90_WGCNA_modules_go_result.RDS")
```

## Significant Go terms visualization for WGCNA modules
```{r GO_TERMS_visualization, include=TRUE, echo=TRUE, fig.height=15, fig.width=35}
WGCNA_modules_go_result<-readRDS("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_wgcna/IMR90_WGCNA_modules_go_result.RDS")

color_pal<-c(brewer.pal(n = 3, "Blues"), brewer.pal(n = 4, "Greens"), brewer.pal(n = 3, "Oranges"), brewer.pal(n = 4, "Purples"))
sig_go_results_list_order<-paste0("Module_", c(14,1,11,13,5,10,12,4,3,8,6,9,7,2))

color_pal_new<-color_pal[c(1:9,11,13:14)]


sig_go_results_df<-data.frame()
for (i in 1:14){
  module<-as.character(sig_go_results_list_order[i])
  go_result<-WGCNA_modules_go_result[[module]]
  go_result[,"module"]<-module
  go_result<-go_result[go_result$p.adjust <= 0.05, ]
  go_result<-go_result[order(as.numeric(go_result$p.adjust), decreasing = F), ][1:20,]
  sig_go_results_df<-rbind(sig_go_results_df, go_result)
}
sig_go_results_df<-na.omit(sig_go_results_df)
sig_go_results_df<-sig_go_results_df[!duplicated(sig_go_results_df$Description),]
#write.csv(sig_go_results_df, file = "/xdisk/mpadi/jiawenyang/result/merkel_cell/pp_in_mcc_paper/table/IMR90_WGCNA_modules_sig_go_result.csv")

p<-ggplot(data=sig_go_results_df, aes(x=factor(Description, levels = sig_go_results_df$Description), y= -log10(p.adjust)), fill = module)+
    geom_col(aes(fill = module), colour = "black", width=0.85, position=position_dodge(0.5)) +
    theme(axis.text.x = element_text(size = 10, angle=90, vjust=.5, hjust=1, face = "bold"),
           panel.background = element_blank(),
           legend.position= c(0.13, 0.7),
           legend.direction = "horizontal",
           legend.title = element_text(colour="black", size=20, 
                                    face="bold"),
           legend.text = element_text(colour="black", size=15, 
                                     face="bold"),
           legend.background = element_rect(fill="grey90",
                                  linewidth =0.5, linetype="solid"),
           axis.text.y = element_text(size = 15, face = "bold"),
           plot.title = element_text(size = 20, face = "bold"),
           axis.title = element_text(size = 20, face = "bold"),
           axis.line = element_line(colour = "black"))+
     ylab("-log10(p.adjust)") + 
     xlab("GO Terms")+
     scale_y_continuous(breaks = seq(0, -log10(min(sig_go_results_df$p.adjust))*1.0, by = 5))+
     scale_fill_manual(values=color_pal_new, limits = c(unique(sig_go_results_df$module)))+
     scale_x_discrete(labels = function(x) str_wrap(x, width = 65))
p
#pdf(file = "/xdisk/mpadi/jiawenyang/result/merkel_cell/pp_in_mcc_paper/figure/IMR90_WGCNA_Modules_GO_enrichment.pdf", width = 35, height = 15)
#plot(p)
#dev.off()
```

## Network centrality analysis and network visualization of gene modules from WGCNA
```{r  centrality analysis, include=TRUE, echo=TRUE, fig.width=20, fig.height=15}
#adjMatrix <- adjacency(t(IMR90_ER_expression_data), power = 16, type = "signed")
#TOM = TOMsimilarity(adjMatrix)
#saveRDS(TOM, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/WGCNA_TOM.rds")

TOM = readRDS("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_wgcna/WGCNA_TOM.rds")
probes = colnames(t(IMR90_ER_expression_data))
dimnames(TOM)<-list(probes, probes)

# 1.Selecting top hub genes from each gene module
network_hub_list<-list()
nTOM = 40 #top nodes from the WGCNA network
for (i in 1:length(gene_df)){
  module<-names(gene_df)[i]
  genes<-gene_df[[module]][,"hgnc_symbol"]
  m<-TOM[genes, genes]
  hubs<-names(sort(rowSums(m), decreasing = T)[1:nTOM])
  network_hub_list[[module]]<-hubs
}

network_hub_list # The top 40 hubs in each module

# 2. Generating adjacency matrix for hub genes from all modules
hub_genes<-unname(unlist(network_hub_list))
hubs_m<-TOM[hub_genes, hub_genes]
edges<-data.frame(from=rownames(hubs_m)[row(hubs_m)[upper.tri(hubs_m)]], 
           to=colnames(hubs_m)[col(hubs_m)[upper.tri(hubs_m)]], 
           value=hubs_m[upper.tri(hubs_m)])

# 3. Setting up thredshold for selecting leading edges in the network
leading_edges_ratio = 0.20 #top 1/5 edges based on edge weight.
threshold = quantile(edges$value, probs=1-leading_edges_ratio , na.rm = FALSE)
edges<-edges[edges$value >= threshold,]

# 4. Organizing vertices data frame and edges data frame for the network
vertices<-data.frame()
for(i in 1:length(network_hub_list)){
  module_name<-names(network_hub_list)[i]
  v<-data.frame(name = network_hub_list[[i]], module = rep(module_name, nTOM), size = rep(8, nTOM))
  vertices<-rbind(vertices, v)
}

vertices[,"group"]<-unlist(lapply(vertices$module, function(x) strsplit(x, "_")[[1]][2]))
vertices[,"id"]<-rownames(vertices)


# 5. Centrality analysis of hub genes co-expression network
g<-graph_from_data_frame(edges, directed = F, vertices)
eigenvector<-eigen_centrality(g)$vector
betweenness<-betweenness(g)
degree<-degree(g)
closeness<-closeness(g)
centralities <- cbind(degree, eigenvector, betweenness, closeness)
centrality_df<-cbind(centralities, vertices$module)
#write.csv(centrality_df, file = "/xdisk/mpadi/jiawenyang/result/merkel_cell/pp_in_mcc_paper/table/IMR90_WGCNA_hubs_netwrok_centrality_analysis.csv")
DT::datatable(centrality_df) #show centrality data of nodes for sorting

# 6. Visualize the hub genes co-expression network
edges[,"source"]<-vertices[match(edges$from, vertices$name), "id"]
edges[,"target"]<-vertices[match(edges$to, vertices$name), "id"]
edges$source<-as.numeric(edges$source)
edges$target<-as.numeric(edges$target)

edges<-data.frame(source = edges$source-1, target = edges$target-1, value = edges$value)
vertices<-cbind(vertices, centralities)
vertices[,"betweenness_sqrt"]<-sqrt(vertices$betweenness)

color_df<-data.frame(color = color_pal, module = c(14,1,11,13,5,10,12,4,3,8,6,9,7,2))
color_df<-color_df[order(as.numeric(sub("\\D+", "", color_df$module))),] #match the module color with previous figures.

ColourScale <- 'd3.scaleOrdinal()
            .domain(["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14"])
           .range(["#9ECAE1", "#6A51A3", "#FDAE6B", "#FEE6CE", "#BAE4B3", "#F2F0F7", "#9E9AC8", "#E6550D", "#CBC9E2", "#74C476", "#3182BD", "#238B45", "#EDF8E9", "#DEEBF7"]);'

fn<-forceNetwork(Links = edges, Nodes = vertices,
                 Source = "source", Target = "target",
                 Nodesize = "betweenness_sqrt", fontSize = 12,
                 Value = "value", NodeID = "name",
                 Group = "group", opacity = 1,
                 legend = T, charge = -20, zoom = F,
                 opacityNoHover = 1,
                 colourScale= JS(ColourScale),
                 linkWidth = JS("function(d) { return Math.cbrt(d.value)*0.4; }")
                 )
fn
```