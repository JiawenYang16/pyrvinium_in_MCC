---
title: "GSE39612_analysis"
author: "Jiawen Yang"
date: "2023-06-21"
output: 
  html_document:
    theme: simplex
    #code_folding: hide
    toc: true
    number_sections: true
    toc_float: true
---
<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 32px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 24px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 12px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r clean environment, include=FALSE, echo = F}
rm(list = ls())
gc()
```

# loading libraries
```{r, load library, include=TRUE, echo=TRUE, warning=FALSE,message=FALSE}
library(limma)
library(WGCNA)
library(edgeR)
library(org.Hs.eg.db)
library(biomaRt)
library(ggplot2)
library(clusterProfiler)
library(ComplexHeatmap)
library(igraph)
library(networkD3)
library(ggpubr)
library(stringr)
```

# Importing data
```{r import data, include=TRUE, echo=TRUE}
#Read GSE39612 data ============================================
edat<-readRDS("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/renormalized_samples_edat_no_celllines.RDS")
sample_list_renormalized<-readRDS("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/renormalized_samples_list_no_celllines.RDS")
GSE39612_annotation<-readRDS(file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/GSE39612_annotation.RDS")
```

# Performing DEG analysis on normal skin samples and MCC tumor samples
```{r DEGs for normal vs.MCC tumor samples, eval = T, include=TRUE, echo=TRUE}
#DEGs for normal vs. MCC tumor samples ============================================
group<-factor(c(rep("normal", 64),  rep("tumor", 30)))
names(group)<-sample_list_renormalized$ID
design = model.matrix(~0 + group)
comparison = "grouptumor-groupnormal"
cont=makeContrasts(comparison,levels=design)
fit=lmFit(edat,design)
fit=contrasts.fit(fit,contrasts=cont)
tfit=treat(fit)
efit=eBayes(tfit)
tdf=topTable(efit,coef=1, n = Inf, adjust = "BH")
#write.csv(tdf, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/gse39612_tumor_vs_normal_DEGs_analysis.csv")
```

# Performing GO term over-representation analysis on DEGs from normal skin vs. MCC tumors comparison
```{r GO_enrichment_analysis, eval = F, include = T, echo = T}
gse39612_mcc.vs.normal_sig<-tdf[abs(tdf$logFC) >=1 & abs(tdf$adj.P.Va) <= 0.05,]
genes<-rownames(gse39612_mcc.vs.normal_sig)
go_term<-enrichGO(genes,
                  OrgDb = org.Hs.eg.db, 
                  ont='BP',
                  pAdjustMethod = 'BH',
                  pvalueCutoff = 0.05, 
                  qvalueCutoff = 0.25,
                  keyType = 'SYMBOL')
df<-go_term@result
write.csv(df, file = "/xdisk/mpadi/jiawenyang/result/merkel_cell/pp_in_mcc_paper/table/GSE39612_tumor_vs_normal_GO_enrichment.csv")
#saveRDS(go_term, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/GSE39612_tumor_vs_normal_GO_enrichment_result.rds")
```

## Plotting enriched go terms
```{r plot GO_enrichment_result, include=TRUE, echo=TRUE, fig.height=12, fig.width=10}
go_term<-readRDS("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/GSE39612_tumor_vs_normal_GO_enrichment_result.rds")
p<-dotplot(go_term, showCategory = 20, font.size = 20, x = "Count")
print(p)
```

## Plotting heatmap for Wnt signaling pathway genes from DEGs
```{r generating heatmap, include=TRUE, echo=TRUE, fig.width=15, fig.height=25}
wnt_signaling_genes<-strsplit(go_term@result[go_term@result$Description == "Wnt signaling pathway","geneID"][1], "/")[[1]]
wnt_signaling_genes_scaled<-t(scale(t(edat[wnt_signaling_genes, sample_list_renormalized$ID])))
wnt_signaling_genes_scaled<-na.omit(wnt_signaling_genes_scaled)

GSE39612_annotation<-GSE39612_annotation[sample_list_renormalized$ID,]
GSE39612_annotation<-GSE39612_annotation[,c("tissue:ch1", "merkel cell polyomavirus status (dna and rna):ch1", "metastasis, primary, or cell line:ch1")]
colnames(GSE39612_annotation)<-c("group", "MCPyV_status", "MCC_status")
GSE39612_annotation$MCPyV_status[!GSE39612_annotation$MCPyV_status %in% c("negative", "positive")]<-"not_available"
GSE39612_annotation$MCC_status[!GSE39612_annotation$MCC_status %in% c("primary tumor", "metastatic tumor")]<-"not_available"

annotation_GSE39612_WNT = HeatmapAnnotation(
  group = GSE39612_annotation$group,
  MCC_status = GSE39612_annotation$MCC_status,
  MCPyV_status = GSE39612_annotation$MCPyV_status,
  col = list(group= c(`normal skin` = "#B7C9F3", `Merkel cell carcinoma` = "#A4312A"),
             MCC_status = c(`not_available` = "#C9CFD0", `metastatic tumor` = "#C47BFC", `primary tumor` = "#01BDC2"),
             MCPyV_status = c(`not_available` = "#C9CFD0", `negative` = "#CCFF99", `positive` = "#FF8000")
  ),
  simple_anno_size = unit(4, "mm"),
  annotation_name_gp= gpar(fontsize = 10, fontface = "bold", col = "black"))

group_column_GSE39612 = factor(GSE39612_annotation$group, levels = c("normal skin", "Merkel cell carcinoma"))

Heatmap(wnt_signaling_genes_scaled,
        heatmap_legend_param = list(title = "Z-scored", title_position = "topleft", legend_height = unit(8, "cm"), legend_direction = "vertical"),
        row_title = "genes",
        cluster_columns = cluster_within_group(wnt_signaling_genes_scaled, group_column_GSE39612),
        column_dend_side = "top",
        show_column_dend = T,
        column_title = "GSE39612 samples",
        show_column_names = F,
        column_title_side = "top",
        column_title_gp = gpar(fontsize = 18, fontface = "bold", col="black"),
        row_names_gp = gpar(fontsize = 10, fontface = "bold"),
        top_annotation = annotation_GSE39612_WNT,
        width = ncol(wnt_signaling_genes_scaled)*unit(3, "mm"), 
        height = nrow(wnt_signaling_genes_scaled)*unit(3, "mm"),
        border = T
)
```


# Performing WGCNA on MCC tumor samples 
```{r WGCNA analysis of MCC tumor data, eval= F, echo=TRUE, include=TRUE}
nettype = "signed"
powers = c(c(1:10), seq(from = 12, to=20, by=2))

MCC_expression_data<-edat[, rownames(GSE39612_annotation[GSE39612_annotation$group=="Merkel cell carcinoma",])]

sft_MCC=pickSoftThreshold(t(MCC_expression_data), dataIsExpr = TRUE, powerVector = powers, networkType = nettype, verbose = 5)

# Scale-free topology fit index as a function of the soft-thresholding power
plot(sft_MCC$fitIndices[,1], -sign(sft_MCC$fitIndices[,3])*sft_MCC$fitIndices[,2],
     xlab="Soft Threshold (power)",ylab= paste0("Scale Free Topology Model Fit ", nettype, " R^2"), type="n",
     main = paste("Scale independence"))+text(sft_MCC$fitIndices[,1], -sign(sft_MCC$fitIndices[,3])*sft_MCC$fitIndices[,2],
     labels=powers,cex=1,col="red")+abline(h=0.90,col="red")

# Mean connectivity as a function of the soft-thresholding power
plot(sft_MCC$fitIndices[,1], sft_MCC$fitIndices[,5],
     xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",
     main = paste("Mean connectivity"))+text(sft_MCC$fitIndices[,1], sft_MCC$fitIndices[,5], labels=powers, cex=1, col="red")

##Create co-expression matrix=========================
cor <- WGCNA::cor
net_MCC = blockwiseModules(
  t(MCC_expression_data),
  power = 16 , #https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/faq.html Q#6 or based on powerEstimate
  TOMType = "signed", 
  minModuleSize = 30,   # We like large modules, so we set the minimum module size relatively high
  reassignThreshold = 0, 
  mergeCutHeight = 0.25,
  numericLabels = TRUE, 
  pamRespectsDendro = FALSE,
  saveTOMs = F,
  verbose = 3
)
table(net_MCC$colors)
cor<-stats::cor
#saveRDS(net_MCC, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/WGCNA_net_mcc.rds")
```

## Calculating co-expressed gene modules
```{r visuzlize the network-1, include=TRUE, echo=TRUE, fig.width=10, fig.height=8}
MCC_expression_data<-edat[, rownames(GSE39612_annotation[GSE39612_annotation$group=="Merkel cell carcinoma",])]
net_MCC<-readRDS(file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/WGCNA_net_mcc.rds")

moduleLabels = net_MCC$colors
MEs = net_MCC$MEs;

# plot Eigengene adjacency heatmap
plotEigengeneNetworks(MEs, "", marDendro = c(0,4,1,2), marHeatmap = c(3,4,1,2), cex.lab = 0.8, xLabelsAngle = 30)
```


## Performing GO-terms analysis on each gene module from MCC tumor samples
```{r organizing_genes_in_each_WGCNA_module_for_G0_TERMS_analysis, include=TRUE, echo=TRUE}
#genemart <- useDataset("hsapiens_gene_ensembl", useMart("ensembl"))
#saveRDS(genemart, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/genemart.rds")

#1.Organizing genes in each WGCNA module for GO-term analysis
genemart<-readRDS("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/imr90_wgcna/genemart.rds")
probes = colnames(t(MCC_expression_data))
g_list<-getBM(filters = "hgnc_symbol", 
                       attributes= c("ensembl_gene_id","hgnc_symbol", "entrezgene_id"),values=probes,mart= genemart)
gene_list<-list()
for (i in 1:length(unique(moduleLabels))){
  number<-unique(moduleLabels)[i]
  module_name<-paste0("Module_", number)
  modnumber<-probes[moduleLabels == number]
  df_genes<-g_list[g_list$hgnc_symbol %in% modnumber,"ensembl_gene_id"]
  gene_list[[module_name]]<-df_genes
}

gene_df<-list()
module_name_list<-paste0("Module_", c(1:14))
for (i in 1:14){
  module_name<-module_name_list[i] #remove Module_0, since it's the module with genes that do not co-express with others
  genes<-gene_list[[module_name]]
  df_genes<-g_list[g_list$ensembl_gene_id %in% genes,]
  df_genes<-df_genes[!duplicated(df_genes$hgnc_symbol),]
  gene_df[[module_name]]<-df_genes
}
```

```{r GO_term enrichment analysis, eval=FALSE, include=TRUE, echo=TRUE}
#2. Performing GO-term over-representation analysis on genes in each module
WGCNA_modules_go_result<-list()
for (i in 1:length(gene_df)){
  module_name<-names(gene_df)[i]
  genes<-gene_df[[module_name]]
  genes<-genes$hgnc_symbol
  em_ER_BP<-enrichGO(genes, 
                     OrgDb = org.Hs.eg.db, 
                     ont = "BP",
                   pAdjustMethod = "BH", 
                     pvalueCutoff = 0.05,
                     qvalueCutoff = 0.25, 
                     keyType = 'SYMBOL')
  go_terms<-em_ER_BP@result
  go_terms<-go_terms[go_terms$p.adjust <= 0.05,]
  go_terms<-go_terms[order(go_terms$Count, decreasing = T),]
  print(module_name)
 WGCNA_modules_go_result[[module_name]]<-em_ER_BP@result
}
#saveRDS(WGCNA_modules_go_result, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/GSE39612_WGCNA_modules_go_result.RDS")
```

## Performing network centrality analysis and network visualization of gene modules from WGCNA
```{r  generate the TOM matrix for centrality analysis, include=TRUE, echo=TRUE, eval=FALSE}
adjMatrix <- adjacency(t(MCC_expression_data), power = 16, type = "signed")
TOM = TOMsimilarity(adjMatrix)
#saveRDS(TOM, file = "/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/WGCNA_TOM.rds")
```

```{r centrality analysis, include=TRUE, echo=TRUE, fig.width=20, fig.height=15}
TOM = readRDS("/xdisk/mpadi/jiawenyang/data/merkel_cell/pp_in_mcc_paper/gse39612/GSE39612_WGCNA_TOM.rds")
probes = colnames(t(MCC_expression_data))
dimnames(TOM)<-list(probes, probes)

# 1.Selecting top hub genes from each gene module
network_hub_list<-list()
nTOM = 40 #top nodes from the WGCNA network
for (i in 1:length(gene_df)){
  module<-names(gene_df)[i]
  genes<-gene_df[[module]][,"hgnc_symbol"]
  m<-TOM[genes, genes]
  hubs<-names(sort(rowSums(m), decreasing = T)[1:nTOM])
  hubs<-na.omit(hubs)
  network_hub_list[[module]]<-hubs
}

network_hub_list # The top 40 hubs in each module

# 2. Generating adjacency matrix for hub genes from all modules
hub_genes<-unname(unlist(network_hub_list))
hubs_m<-TOM[hub_genes, hub_genes]
edges<-data.frame(from=rownames(hubs_m)[row(hubs_m)[upper.tri(hubs_m)]], 
           to=colnames(hubs_m)[col(hubs_m)[upper.tri(hubs_m)]], 
           value=hubs_m[upper.tri(hubs_m)])

# 3. Setting up thredshold for selecting leading edges in the network
leading_edges_ratio = 0.20 #top 1/5 edges based on edge weight.
threshold = quantile(edges$value, probs=1-leading_edges_ratio , na.rm = FALSE)
edges<-edges[edges$value >= threshold,]

# 4. Organizing vertices data frame and edges data frame for the network
vertices<-data.frame()
for(i in 1:length(network_hub_list)){
  module_name<-names(network_hub_list)[i]
  v<-data.frame(name = network_hub_list[[i]], module = rep(module_name, nTOM), size = rep(8, nTOM))
  vertices<-rbind(vertices, v)
}

vertices[,"group"]<-unlist(lapply(vertices$module, function(x) strsplit(x, "_")[[1]][2]))
vertices[,"id"]<-rownames(vertices)


# 5. Centrality analysis of hub genes co-expression network
g<-graph_from_data_frame(edges, directed = F, vertices)
eigenvector<-eigen_centrality(g)$vector
betweenness<-betweenness(g)
degree<-degree(g)
closeness<-closeness(g)
centralities <- cbind(degree, eigenvector, betweenness, closeness)
centrality_df<-cbind(centralities, vertices$module)
#write.csv(centrality_df, file = "/xdisk/mpadi/jiawenyang/result/merkel_cell/pp_in_mcc_paper/table/IMR90_WGCNA_hubs_netwrok_centrality_analysis.csv")
DT::datatable(centrality_df) #show centrality data of nodes for sorting

# 6. Visualize the hub genes co-expression network
edges[,"source"]<-vertices[match(edges$from, vertices$name), "id"]
edges[,"target"]<-vertices[match(edges$to, vertices$name), "id"]
edges$source<-as.numeric(edges$source)
edges$target<-as.numeric(edges$target)

edges<-data.frame(source = edges$source-1, target = edges$target-1, value = edges$value)
vertices<-cbind(vertices, centralities)
vertices[,"betweenness_sqrt"]<-sqrt(vertices$betweenness)

fn<-forceNetwork(Links = edges, Nodes = vertices,
                 Source = "source", Target = "target",
                 Nodesize = "betweenness_sqrt", fontSize = 12,
                 Value = "value", NodeID = "name",
                 Group = "group", opacity = 1,
                 legend = T, charge = -20, zoom = F,
                 opacityNoHover = 1,
                 linkWidth = JS("function(d) { return Math.cbrt(d.value)*0.4; }")
                 )
fn
```

## Plotting the gene modules that closely co-expressed in MCC tumor samples
```{r visualize the closely co-expressed gene modules (3/6/5), include=TRUE, echo =TRUE, fig.width=25, fig.height=13}
theme<-theme(panel.background = element_blank(),
             panel.border=element_rect(fill=NA),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             strip.background=element_blank(),
             axis.text.x=element_text(colour="black"),
             axis.text.y=element_text(colour="black"),
             axis.ticks=element_line(colour="black"),
             plot.margin=unit(c(1,1,1,1),"line"),
             axis.title.x = element_text(color="black", size=18, face="bold"),
             axis.title.y = element_text(color="black", size=18, face="bold"),
             axis.text = element_text(size = 12, face = "bold"))

n = 25
em_m3_BP<-enrichGO(gene_df$Module_3$hgnc_symbol, 
                     OrgDb = org.Hs.eg.db, 
                     ont = "BP",
                     pAdjustMethod = "BH", 
                     pvalueCutoff = 0.05,
                     qvalueCutoff = 0.25, 
                     keyType = 'SYMBOL')
m3_BP<-em_m3_BP@result[order(em_m3_BP@result$Count, decreasing = T),][1:n,]
pm3<-ggplot(m3_BP, aes(x=Count, y=factor(Description, levels = rev(c(m3_BP$Description))), size = Count, color = p.adjust))+
      geom_point() +
      ylab("Enriched GO Terms in module 3")+
      scale_colour_gradient(low = "#F16913", high = "#FDD0A2") +
      scale_fill_gradient(low = "#F16913", high = "#FDD0A2") +
      scale_y_discrete(labels = function(x) str_wrap(x, width = 40))+
      theme_set(theme_bw() +
      theme(legend.position = "right"))+
      theme

em_m5_BP<-enrichGO(gene_df$Module_5$hgnc_symbol, 
                     OrgDb = org.Hs.eg.db, 
                     ont = "BP",
                     pAdjustMethod = "BH", 
                     pvalueCutoff = 0.05,
                     qvalueCutoff = 0.25, 
                     keyType = 'SYMBOL')
m5_BP<-em_m5_BP@result[order(em_m5_BP@result$Count, decreasing = T),][1:n,]
pm5<-ggplot(m5_BP, aes(x=Count, y=factor(Description, levels = rev(c(m5_BP$Description))), size = Count, color = p.adjust))+
      geom_point() +
      ylab("Enriched GO Terms in module 5")+
      scale_colour_gradient(low = "#238B45", high = "#A1D99B") +
      scale_fill_gradient(low = "#238B45", high = "#A1D99B") +
      scale_y_discrete(labels = function(x) str_wrap(x, width = 40))+
      theme_set(theme_bw() +
      theme(legend.position = "right"))+
      theme

em_m6_BP<-enrichGO(gene_df$Module_6$hgnc_symbol, 
                     OrgDb = org.Hs.eg.db, 
                     ont = "BP",
                     pAdjustMethod = "BH", 
                     pvalueCutoff = 0.05,
                     qvalueCutoff = 0.25, 
                     keyType = 'SYMBOL')
m6_BP<-em_m6_BP@result[order(em_m6_BP@result$Count, decreasing = T),][1:n,]
pm6<-ggplot(m6_BP, aes(x=Count, y=factor(Description, levels = rev(c(m6_BP$Description))), size = Count, color = p.adjust))+
      geom_point() +
      ylab("Enriched GO Terms in module 6")+
      scale_colour_gradient(low = "#74C476", high = "#E5F5E0") +
      scale_fill_gradient(low = "#74C476", high = "#E5F5E0") +
      scale_y_discrete(labels = function(x) str_wrap(x, width = 40))+
      theme_set(theme_bw() +
      theme(legend.position = "right"))+
      theme

WGCNA_module_GO_terms_plot<-ggarrange(pm3, pm5, pm6,
              ncol = 3,
              nrow = 1
) 
WGCNA_module_GO_terms_plot
```

# Correlation analysis on genes of interests
```{r correlation analysis on wnt genes and }
cor_df<-list()
for (i in 1:length(IMR90_5_period)){
  file<-IMR90_5_period[i]
  id<-strsplit(basename(file), "[.]")[[1]][1]
  id<-paste0(strsplit(id, "_")[[1]][4], "_", strsplit(id, "_")[[1]][5])
  df<-readRDS(file)
  df<-reshape2::melt(df$pc)
  df$typeofVar1<-unlist(lapply(as.character(df$Var1), function(x) strsplit(x, "_")[[1]][2]))
  df$typeofVar2<-unlist(lapply(as.character(df$Var2), function(x) strsplit(x,"_")[[1]][2]))
  colnames(df)<-c("Var1", "Var2", "Pearson correlation coefficient", "typeofVar1", "typeofVar2")
  df$p.value<-reshape2::melt(readRDS(file)$pc.pvalue)[,"value"]
  df<-df[df$Var1!=df$Var2,]
  df1<-df[df$typeofVar1 == "neural",]
  df2<-df[df$typeofVar1 =="wnt" & df$typeofVar2 == "wnt", ]
  df<-rbind(df1, df2)
  df<-df[df$p.value <=0.01,]
  df$Var1<-unlist(lapply(as.character(df$Var1), function(x) strsplit(x, "_")[[1]][1]))
  df$Var2<-unlist(lapply(as.character(df$Var2), function(x) strsplit(x, "_")[[1]][1]))
  cor_df[[id]]<-df
}

for(i in 1:length(names(cor_df))){
  df<-cor_df[[i]]
  name<-names(cor_df)[i]
  #pdf(file = paste0(COR_RESULT_DIR, name,".pdf"))
  p=ggplot(df, aes(x = `Pearson correlation coefficient`))+
    geom_histogram(color = "darkblue", fill = "lightblue", binwidth = 0.1)+
    labs(title =  paste0("Wnt and neural genes correlation histogram -", name), y = "Count") +
    ylim(0, 8000)+
    geom_vline(aes(xintercept = c(0.8)), color = "red", linetype = "dashed", size = 1)+
    geom_vline(aes(xintercept = c(-0.8)), color = "blue", linetype = "dashed", size = 1)
  p=p+theme
  print(p)
}
```
